var e = require("react");

var t = require("react-ssr-prepass");

var n = require("urql");

function _interopDefaultLegacy(e) {
  return e && "object" == typeof e && "default" in e ? e.default : e;
}

var r = _interopDefaultLegacy(t);

function _extends() {
  return (_extends = Object.assign || function(e) {
    for (var t = 1; t < arguments.length; t++) {
      var n = arguments[t];
      for (var r in n) {
        if (Object.prototype.hasOwnProperty.call(n, r)) {
          e[r] = n[r];
        }
      }
    }
    return e;
  }).apply(this, arguments);
}

var i = null;

function resetClient() {
  i = null;
}

function initUrqlClient(e, t) {
  var r = "undefined" == typeof window;
  if (r || !i) {
    (i = n.createClient(_extends({}, e, {
      suspense: t && (r || e.suspense)
    }))).toJSON = function() {
      return null;
    };
  }
  return i;
}

var a;

exports.initUrqlClient = initUrqlClient;

exports.withUrqlClient = function withUrqlClient(t, i) {
  if (!i) {
    i = {};
  }
  return function(l) {
    var u = Boolean((l.getInitialProps || i.ssr) && !i.neverSuspend);
    var WithUrql = function(r) {
      var o = r.pageProps;
      var s = r.urqlClient;
      var c = r.urqlState;
      var f = function objectWithoutProperties(e, t) {
        var n = {};
        for (var r in e) {
          if (Object.prototype.hasOwnProperty.call(e, r) && -1 === t.indexOf(r)) {
            n[r] = e[r];
          }
        }
        return n;
      }(r, [ "pageProps", "urqlClient", "urqlState" ]);
      var p = e.useReducer((function(e) {
        return e + 1;
      }), 0);
      var v = p[0];
      var d = p[1];
      var h = o && o.urqlState || c;
      var g = e.useMemo((function() {
        if (s && !v) {
          return s;
        }
        if (!a || "undefined" == typeof window) {
          a = n.ssrExchange({
            initialState: h,
            isClient: !0,
            staleWhileRevalidate: "undefined" != typeof window ? i.staleWhileRevalidate : void 0
          });
        } else if (!v) {
          a.restoreData(h);
        }
        var e = t(a);
        if (!e.exchanges) {
          e.exchanges = [ n.dedupExchange, n.cacheExchange, a, n.fetchExchange ];
        }
        return initUrqlClient(e, u);
      }), [ s, h, v ]);
      var x = e.useCallback((function() {
        resetClient();
        a = n.ssrExchange({
          initialState: void 0
        });
        d();
      }), []);
      return e.createElement(n.Provider, {
        value: g
      }, e.createElement(l, _extends({}, f, {
        pageProps: o,
        urqlClient: g,
        resetUrqlClient: x
      })));
    };
    WithUrql.displayName = "withUrqlClient(" + (l.displayName || l.name || "Component") + ")";
    if (l.getLayout) {
      WithUrql.getLayout = l.getLayout;
    }
    if (l.getInitialProps || i.ssr) {
      WithUrql.getInitialProps = function(a) {
        try {
          let d = !1;
          function _temp4(t) {
            if (d) {
              return t;
            }
            function _temp2() {
              return _extends({}, v, {
                urqlState: c ? c.extractData() : void 0,
                urqlClient: p
              });
            }
            if ("undefined" != typeof window) {
              return _extends({}, v, {
                urqlClient: p
              });
            }
            var n = _extends({}, v, {
              urqlClient: p
            });
            var a = o ? n : {
              pageProps: n
            };
            const l = function() {
              if (!i.neverSuspend) {
                return Promise.resolve(r(e.createElement(u, a))).then((function() {}));
              }
            }();
            return l && l.then ? l.then(_temp2) : _temp2();
          }
          var u = a.AppTree;
          var o = !!a.Component;
          var s = o ? a.ctx : a;
          var c = n.ssrExchange({
            initialState: void 0
          });
          var f = t(c, s);
          if (!f.exchanges) {
            f.exchanges = [ n.dedupExchange, n.cacheExchange, c, n.fetchExchange ];
          }
          var p = initUrqlClient(f, !i.neverSuspend);
          if (p) {
            s.urqlClient = p;
          }
          var v = {};
          const h = function() {
            if (l.getInitialProps) {
              return Promise.resolve(l.getInitialProps(a)).then((function(e) {
                v = e;
                if (s.res && (s.res.writableEnded || s.res.finished)) {
                  d = !0;
                  return _extends({}, v, {
                    urqlClient: p
                  });
                }
              }));
            }
          }();
          return Promise.resolve(h && h.then ? h.then(_temp4) : _temp4(h));
        } catch (e) {
          return Promise.reject(e);
        }
      };
    }
    return WithUrql;
  };
};
//# sourceMappingURL=next-urql.js.map
